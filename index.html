<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khai báo Lưu trú</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div>
                <h1 class="text-2xl font-bold text-blue-800">Hệ Thống Nhập Liệu Lưu Trú</h1>
                <p class="text-gray-500 text-sm font-medium">Đồng bộ dữ liệu trực tiếp với trình duyệt tự động</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importJSON(event)">
                <button onclick="document.getElementById('importFile').click()" class="bg-amber-50 hover:bg-amber-100 text-amber-700 px-4 py-2 rounded-xl transition border border-amber-200">
                    <i class="fa-solid fa-file-import mr-2"></i>Nhập JSON
                </button>
                <button onclick="exportJSON()" class="bg-gray-50 hover:bg-gray-100 text-gray-700 px-4 py-2 rounded-xl transition border border-gray-300">
                    <i class="fa-solid fa-download mr-2"></i>Xuất JSON
                </button>
                <button onclick="sendToPython()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition transform active:scale-95 border border-blue-700">
                    <i class="fa-solid fa-paper-plane mr-2"></i>GỬI ĐẾN TRÌNH DUYỆT
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-5 bg-white p-6 rounded-2xl shadow-sm border border-gray-200 sticky top-6 h-fit max-h-[90vh] overflow-y-auto">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center border-b pb-2">
                    <i class="fa-solid fa-user-plus mr-2 text-blue-600"></i>Thông tin chi tiết khách
                </h2>
                <form id="guestForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Họ và tên</label>
                            <input type="text" id="ho_ten" name="ho_ten" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 uppercase focus:ring-2 focus:ring-blue-500 outline-none" placeholder="TRẦN PHÚ PHÀM" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Số CCCD</label>
                            <input type="text" id="cccd" name="cccd" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0872..." required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Ngày sinh</label>
                            <input type="text" id="ngay_birth" name="ngay_birth" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="29/09/2006" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Giới tính</label>
                            <select id="gioi_tinh" name="gioi_tinh" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 bg-white">
                                <option>Nam</option>
                                <option>Nữ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Số phòng</label>
                            <input type="text" id="so_phong" name="so_phong" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="C11">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Dân tộc</label>
                            <input type="text" name="dan_toc" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Kinh">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Quốc tịch</label>
                            <input type="text" name="quoc_tich" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Việt Nam">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Nghề nghiệp</label>
                            <input type="text" name="nghe_nghiep" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Tự do">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Nơi làm việc</label>
                            <input type="text" name="noi_lam_viec" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Tự do">
                        </div>
                    </div>

                    <details class="group bg-gray-50 rounded-xl overflow-hidden border border-gray-100" open>
                        <summary class="text-sm text-gray-600 cursor-pointer font-bold p-3 bg-gray-100 list-none flex justify-between items-center">
                            <span>ĐỊA CHỈ THƯỜNG TRÚ</span>
                            <i class="fa-solid fa-chevron-down text-xs group-open:rotate-180 transition"></i>
                        </summary>
                        <div class="p-4 space-y-3 border-t border-gray-200">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Tỉnh / TP</label>
                                <input type="text" name="tinh" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Tỉnh Đồng Tháp">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Xã / Phường</label>
                                <input type="text" name="xa" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Xã Tân Long">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Địa chỉ chi tiết (Ấp/Số nhà)</label>
                                <input type="text" name="dia_chi_chi_tiet" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Ấp Tân Thạnh">
                            </div>
                        </div>
                    </details>

                    <div class="grid grid-cols-2 gap-3 bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-blue-600 uppercase tracking-wider">Lý do lưu trú</label>
                            <input type="text" name="ly_do" class="mt-1 block w-full border border-blue-200 rounded-lg p-2" value="Đi học">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-600 uppercase tracking-wider">Lưu trú từ ngày</label>
                            <input type="text" name="thoi_gian_luu_tru" class="mt-1 block w-full border border-blue-200 rounded-lg p-2" value="13/12/2025">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-600 uppercase tracking-wider">Lưu trú đến ngày</label>
                            <input type="text" name="luu_tru_den" class="mt-1 block w-full border border-blue-200 rounded-lg p-2" value="31/12/2025">
                        </div>
                    </div>

                    <button type="button" onclick="addToTable()" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition font-bold shadow-md shadow-blue-100 flex justify-center items-center">
                        <i class="fa-solid fa-user-plus mr-2"></i>Thêm vào danh sách
                    </button>
                </form>
            </div>

            <div class="lg:col-span-7 bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-fit">
                <div class="p-5 border-b bg-white flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-800">
                        Danh sách chờ gửi 
                        <span id="count" class="ml-2 px-2.5 py-0.5 bg-blue-100 text-blue-600 rounded-full text-sm font-bold">0</span>
                    </h2>
                    <button onclick="clearAll()" class="text-gray-400 hover:text-red-500 transition text-sm font-bold flex items-center">
                        <i class="fa-solid fa-trash-can mr-2"></i>Xóa sạch
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase">Khách hàng</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase">Phòng</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="guestTable" class="divide-y divide-gray-100 bg-white">
                            <tr id="emptyRow">
                                <td colspan="3" class="px-6 py-12 text-center text-gray-400">
                                    <i class="fa-solid fa-inbox text-4xl mb-3 block opacity-20"></i>
                                    Trống.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let guestList = [];

        function addToTable() {
            const form = document.getElementById('guestForm');
            const formData = new FormData(form);
            
            if(!formData.get('ho_ten') || !formData.get('cccd')) return;

            const guest = {
                ho_ten: formData.get('ho_ten').toUpperCase().trim(),
                cccd: formData.get('cccd').trim(),
                ngay_birth: formData.get('ngay_birth').trim(),
                gioi_tinh: formData.get('gioi_tinh'),
                quoc_gia: "Cộng hòa xã hội chủ nghĩa Việt Nam",
                quoc_tich: formData.get('quoc_tich'),
                dan_toc: formData.get('dan_toc'),
                noi_lam_viec: formData.get('noi_lam_viec'),
                nghe_nghiep: formData.get('nghe_nghiep'),
                so_phong: formData.get('so_phong').trim(),
                tinh: formData.get('tinh').trim(),
                xa: formData.get('xa').trim(),
                ly_do: formData.get('ly_do'),
                dia_chi_chi_tiet: formData.get('dia_chi_chi_tiet').trim(),
                thoi_gian_luu_tru: formData.get('thoi_gian_luu_tru'),
                luu_tru_den: formData.get('luu_tru_den')
            };

            guestList.push(guest);
            renderTable();
            // Reset fields but keep address/reason defaults
            document.getElementById('ho_ten').value = '';
            document.getElementById('cccd').value = '';
            document.getElementById('ngay_birth').value = '';
            document.getElementById('ho_ten').focus();
        }

        function renderTable() {
            const tableBody = document.getElementById('guestTable');
            const countEl = document.getElementById('count');
            
            if (guestList.length === 0) {
                tableBody.innerHTML = `<tr id="emptyRow"><td colspan="3" class="px-6 py-12 text-center text-gray-400 italic">Trống.</td></tr>`;
            } else {
                tableBody.innerHTML = '';
                guestList.forEach((g, index) => {
                    tableBody.innerHTML += `
                        <tr class="hover:bg-blue-50 transition border-l-4 border-transparent hover:border-blue-500">
                            <td class="px-4 py-3">
                                <div class="font-bold text-gray-900">${g.ho_ten}</div>
                                <div class="text-xs text-gray-400 font-mono">${g.cccd} | ${g.ngay_birth}</div>
                            </td>
                            <td class="px-4 py-3 text-center text-gray-600 font-bold">${g.so_phong}</td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="removeGuest(${index})" class="text-red-400 hover:text-red-600">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            }
            countEl.innerText = guestList.length;
        }

        function removeGuest(index) {
            guestList.splice(index, 1);
            renderTable();
        }

        function clearAll() {
            if(confirm("Xóa toàn bộ?")) {
                guestList = [];
                renderTable();
            }
        }

        function exportJSON() {
            if(guestList.length === 0) return alert("Không có dữ liệu!");
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({items: guestList}, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `data_luutru_${new Date().getTime()}.json`);
            dlAnchor.click();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.items) {
                        guestList = [...guestList, ...data.items];
                        renderTable();
                    }
                } catch (err) { alert("Lỗi JSON!"); }
            };
            reader.readAsText(file);
        }

        async function sendToPython() {
            if (guestList.length === 0) return alert("Danh sách trống!");
            const btn = event.currentTarget;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> ĐANG GỬI...`;
            btn.disabled = true;

            try {
                const response = await fetch('http://127.0.0.1:8000/send-to-web', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: guestList })
                });
                const result = await response.json();
                alert("THÀNH CÔNG: " + result.message);
            } catch (error) {
                alert("LỖI: Kiểm tra browser.py!");
            } finally {
                btn.innerHTML = `<i class="fa-solid fa-paper-plane mr-2"></i>GỬI ĐẾN TRÌNH DUYỆT`;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>