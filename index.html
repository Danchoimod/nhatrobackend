<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khai báo Lưu trú</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div>
                <h1 class="text-2xl font-bold text-blue-800">Hệ Thống Nhập Liệu Lưu Trú</h1>
                <p class="text-gray-500 text-sm font-medium">Đồng bộ dữ liệu trực tiếp với trình duyệt tự động</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importJSON(event)">
                <button onclick="document.getElementById('importFile').click()" class="bg-amber-50 hover:bg-amber-100 text-amber-700 px-4 py-2 rounded-xl transition border border-amber-200">
                    <i class="fa-solid fa-file-import mr-2"></i>Nhập JSON
                </button>
                <button onclick="exportJSON()" class="bg-gray-50 hover:bg-gray-100 text-gray-700 px-4 py-2 rounded-xl transition border border-gray-300">
                    <i class="fa-solid fa-download mr-2"></i>Xuất JSON
                </button>
                <button onclick="sendToPython()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition transform active:scale-95 border border-blue-700">
                    <i class="fa-solid fa-paper-plane mr-2"></i>GỬI ĐẾN TRÌNH DUYỆT
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-200 sticky top-6 h-fit">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                    <i class="fa-solid fa-user-plus mr-2 text-blue-600"></i>Thêm khách hàng
                </h2>
                <form id="guestForm" class="space-y-4">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Họ và tên</label>
                            <input type="text" id="ho_ten" name="ho_ten" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 uppercase focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="TRẦN PHÚ PHÀM" required>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Số CCCD</label>
                                <input type="text" id="cccd" name="cccd" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="0872..." required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Ngày sinh</label>
                                <input type="text" id="ngay_birth" name="ngay_birth" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="29/09/2006" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Giới tính</label>
                                <select id="gioi_tinh" name="gioi_tinh" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 outline-none transition bg-white">
                                    <option>Nam</option>
                                    <option>Nữ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Phòng</label>
                                <input type="text" id="so_phong" name="so_phong" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="C11">
                            </div>
                        </div>
                    </div>
                    
                    <details class="group bg-gray-50 rounded-xl overflow-hidden border border-gray-100">
                        <summary class="text-sm text-gray-600 cursor-pointer font-bold p-3 bg-gray-50 hover:bg-gray-100 transition list-none flex justify-between items-center">
                            <span>THÔNG TIN NƠI Ở CŨ</span>
                            <i class="fa-solid fa-chevron-down text-xs group-open:rotate-180 transition"></i>
                        </summary>
                        <div class="p-4 space-y-3 border-t border-gray-100">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Tỉnh/TP</label>
                                <input type="text" id="tinh" name="tinh" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 bg-white" value="Tỉnh Đồng Tháp">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Xã/Phường</label>
                                <input type="text" id="xa" name="xa" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 bg-white" value="Xã Tân Long">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Địa chỉ chi tiết (Ấp/Số nhà)</label>
                                <input type="text" id="dia_chi_chi_tiet" name="dia_chi_chi_tiet" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 bg-white" placeholder="Ấp Tân Thạnh">
                            </div>
                        </div>
                    </details>

                    <button type="button" onclick="addToTable()" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition font-bold shadow-md shadow-blue-100 flex justify-center items-center">
                        <i class="fa-solid fa-user-plus mr-2"></i>Thêm vào danh sách
                    </button>
                </form>
            </div>

            <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">
                <div class="p-5 border-b bg-white flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-800">
                        Danh sách chờ gửi 
                        <span id="count" class="ml-2 px-2.5 py-0.5 bg-blue-100 text-blue-600 rounded-full text-sm font-bold">0</span>
                    </h2>
                    <button onclick="clearAll()" class="text-gray-400 hover:text-red-500 transition text-sm font-bold flex items-center">
                        <i class="fa-solid fa-trash-can mr-2"></i>Xóa sạch danh sách
                    </button>
                </div>
                <div class="overflow-x-auto flex-grow max-h-[calc(100vh-250px)]">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Họ tên / CCCD</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest text-center">Giới tính</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest text-center">Phòng</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest text-right">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="guestTable" class="divide-y divide-gray-100 bg-white">
                            <tr id="emptyRow">
                                <td colspan="4" class="px-6 py-12 text-center text-gray-400">
                                    <i class="fa-solid fa-inbox text-4xl mb-3 block opacity-20"></i>
                                    Chưa có dữ liệu. Vui lòng thêm khách hàng mới.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let guestList = [];

        function addToTable() {
            const form = document.getElementById('guestForm');
            const formData = new FormData(form);
            
            if(!formData.get('ho_ten') || !formData.get('cccd')) return;

            // Đảm bảo đầy đủ các trường thông tin theo yêu cầu
            const guest = {
                ho_ten: formData.get('ho_ten').toUpperCase().trim(),
                cccd: formData.get('cccd').trim(),
                ngay_birth: formData.get('ngay_birth').trim(),
                gioi_tinh: formData.get('gioi_tinh'),
                quoc_gia: "Cộng hòa xã hội chủ nghĩa Việt Nam",
                quoc_tich: "Việt Nam",
                dan_toc: "Kinh",
                noi_lam_viec: "Tự do",
                nghe_nghiep: "Tự do",
                so_phong: formData.get('so_phong').trim(),
                tinh: formData.get('tinh').trim(),
                xa: formData.get('xa').trim(),
                ly_do: "Đi học",
                dia_chi_chi_tiet: formData.get('dia_chi_chi_tiet').trim(),
                thoi_gian_luu_tru: new Date().toLocaleDateString('en-GB'), // DD/MM/YYYY
                luu_tru_den: "31/12/2025"
            };

            guestList.push(guest);
            renderTable();
            form.querySelector('#ho_ten').focus();
            form.reset();
            // Giữ lại các giá trị mặc định cho tỉnh/xã sau khi reset
            document.getElementById('tinh').value = "Tỉnh Đồng Tháp";
            document.getElementById('xa').value = "Xã Tân Long";
        }

        function renderTable() {
            const tableBody = document.getElementById('guestTable');
            const countEl = document.getElementById('count');
            
            if (guestList.length === 0) {
                tableBody.innerHTML = `
                    <tr id="emptyRow">
                        <td colspan="4" class="px-6 py-12 text-center text-gray-400">
                            <i class="fa-solid fa-inbox text-4xl mb-3 block opacity-20"></i>
                            Chưa có dữ liệu. Vui lòng thêm khách hàng mới.
                        </td>
                    </tr>`;
            } else {
                tableBody.innerHTML = '';
                guestList.forEach((g, index) => {
                    tableBody.innerHTML += `
                        <tr class="hover:bg-blue-50/50 transition border-transparent hover:border-blue-100 border-l-4">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-bold text-gray-900">${g.ho_ten}</div>
                                <div class="text-xs text-gray-400 font-mono">${g.cccd}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span class="px-2 py-1 ${g.gioi_tinh === 'Nam' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600'} rounded text-xs font-bold">
                                    ${g.gioi_tinh}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-gray-600 font-bold">${g.so_phong}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <button onclick="removeGuest(${index})" class="p-2 text-gray-300 hover:text-red-500 transition">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            }
            countEl.innerText = guestList.length;
        }

        function removeGuest(index) {
            guestList.splice(index, 1);
            renderTable();
        }

        function clearAll() {
            if(confirm("Xóa toàn bộ danh sách hiện tại?")) {
                guestList = [];
                renderTable();
            }
        }

        function exportJSON() {
            if(guestList.length === 0) return alert("Không có dữ liệu để xuất!");
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({items: guestList}, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `khach_luu_tru_${new Date().getTime()}.json`);
            dlAnchor.click();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.items && Array.isArray(data.items)) {
                        guestList = [...guestList, ...data.items];
                        renderTable();
                    }
                } catch (err) { alert("Lỗi định dạng file JSON!"); }
            };
            reader.readAsText(file);
        }

        async function sendToPython() {
            if (guestList.length === 0) return alert("Danh sách trống!");
            
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> ĐANG GỬI...`;
            btn.disabled = true;

            try {
                const response = await fetch('http://127.0.0.1:8000/send-to-web', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: guestList })
                });

                const result = await response.json();
                alert("THÀNH CÔNG: " + result.message);
            } catch (error) {
                alert("LỖI: Không thể kết nối đến browser.py. Hãy kiểm tra server đã chạy chưa?");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>