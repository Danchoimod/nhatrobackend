<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khai báo Lưu trú</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Animation cho trạng thái đang chạy */
        @keyframes pulse-border {
            0%, 100% { border-color: #eab308; }
            50% { border-color: #fca5a5; }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-blue-800 flex items-center">
                        <i class="fa-solid fa-hotel mr-2"></i> Hệ Thống Nhập Liệu Lưu Trú
                    </h1>
                    <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">Đồng bộ dữ liệu trực tiếp qua WebSocket</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importJSON(event)">
                    <button onclick="document.getElementById('importFile').click()" class="bg-amber-50 hover:bg-amber-100 text-amber-700 px-4 py-2 rounded-xl transition border border-amber-200 text-sm font-semibold">
                        <i class="fa-solid fa-file-import mr-1"></i> Nhập JSON
                    </button>
                    <select id="branchSelect" onchange="onBranchChange()" class="bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-xl transition border border-blue-200 text-sm font-semibold cursor-pointer">
                        <option value="1">Tâm An 1</option>
                        <option value="2">Tâm An 2</option>
                    </select>
                    <button onclick="exportJSON()" class="bg-gray-50 hover:bg-gray-100 text-gray-700 px-4 py-2 rounded-xl transition border border-gray-300 text-sm font-semibold">
                        <i class="fa-solid fa-download mr-1"></i> Xuất
                    </button>
                    <button onclick="sendToPython()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition transform active:scale-95 border border-blue-700 text-sm">
                        <i class="fa-solid fa-paper-plane mr-1"></i> GỬI ĐẾN TRÌNH DUYỆT
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Modal Chọn Chi Nhánh -->
    <div id="branchModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                    <i class="fa-solid fa-building text-3xl text-blue-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">Chọn Chi Nhánh</h3>
                <p class="text-gray-500 mt-2">Vui lòng chọn chi nhánh để bắt đầu</p>
            </div>
            <div class="space-y-3">
                <button onclick="selectBranch('1')" class="w-full p-4 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl font-bold shadow-lg transition transform hover:scale-105 flex items-center justify-between">
                    <span><i class="fa-solid fa-hotel mr-2"></i>Hộ Kinh Doanh Nhà Trọ Tâm An 1</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
                <button onclick="selectBranch('2')" class="w-full p-4 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-xl font-bold shadow-lg transition transform hover:scale-105 flex items-center justify-between">
                    <span><i class="fa-solid fa-hotel mr-2"></i>NHÀ TRỌ TÂM AN 2</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Đang Chọn Chi Nhánh -->
    <div id="branchSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
            <div class="flex items-center justify-center mb-6">
                <div class="bg-blue-100 rounded-full p-4">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600"></i>
                </div>
            </div>
            <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">Đang chọn chi nhánh</h3>
            <div id="selectionSteps" class="space-y-3 text-sm">
                <!-- Steps will be added dynamically -->
            </div>
            <div class="mt-6 text-center">
                <div class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-semibold">
                    <i class="fa-solid fa-circle-notch fa-spin mr-2"></i>
                    Vui lòng đợi...
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-5">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 sticky top-28 h-fit max-h-[80vh] overflow-y-auto">
                    <h2 id="formTitle" class="text-lg font-bold mb-4 text-gray-800 flex items-center border-b pb-2">
                        <i class="fa-solid fa-user-plus mr-2 text-blue-600"></i>Thông tin chi tiết khách
                    </h2>
                    <form id="guestForm" class="space-y-4">
                        <input type="hidden" id="editIndex" value="-1">
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Họ và tên</label>
                                <input type="text" id="ho_ten" name="ho_ten" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 uppercase focus:ring-2 focus:ring-blue-500 outline-none font-semibold" placeholder="TRẦN PHÚ PHÀM" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Số CCCD</label>
                                <input type="text" id="cccd" name="cccd" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0872..." required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Ngày sinh</label>
                                <input type="text" id="ngay_birth" name="ngay_birth" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="29/09/2006" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Giới tính</label>
                                <select id="gioi_tinh" name="gioi_tinh" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 bg-white">
                                    <option>Nam</option>
                                    <option>Nữ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Số phòng</label>
                                <input type="text" id="so_phong" name="so_phong" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-blue-600" placeholder="C11">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Dân tộc</label>
                                <input type="text" id="dan_toc" name="dan_toc" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Kinh">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Quốc tịch</label>
                                <input type="text" id="quoc_tich" name="quoc_tich" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Việt Nam">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Nghề nghiệp</label>
                                <input type="text" id="nghe_nghiep" name="nghe_nghiep" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Tự do">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Nơi làm việc</label>
                                <input type="text" id="noi_lam_viec" name="noi_lam_viec" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Tự do">
                            </div>
                        </div>

                        <details class="group bg-gray-50 rounded-xl overflow-hidden border border-gray-100" open>
                            <summary class="text-sm text-gray-600 cursor-pointer font-bold p-3 bg-gray-100 list-none flex justify-between items-center">
                                <span>ĐỊA CHỈ THƯỜNG TRÚ</span>
                                <i class="fa-solid fa-chevron-down text-xs group-open:rotate-180 transition"></i>
                            </summary>
                            <div class="p-4 space-y-3 border-t border-gray-200">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Tỉnh / TP</label>
                                    <input type="text" id="tinh" name="tinh" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Tỉnh Đồng Tháp">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Xã / Phường</label>
                                    <input type="text" id="xa" name="xa" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Xã Tân Long">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Địa chỉ chi tiết</label>
                                    <input type="text" id="dia_chi_chi_tiet" name="dia_chi_chi_tiet" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" value="Ấp Tân Thạnh">
                                </div>
                            </div>
                        </details>

                        <div class="grid grid-cols-2 gap-3 bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-blue-600 uppercase tracking-wider">Lý do lưu trú</label>
                                <input type="text" id="ly_do" name="ly_do" class="mt-1 block w-full border border-blue-200 rounded-lg p-2" value="Đi học">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-blue-600 uppercase tracking-wider">Từ ngày</label>
                                <input type="text" id="thoi_gian_luu_tru" name="thoi_gian_luu_tru" class="mt-1 block w-full border border-blue-200 rounded-lg p-2" value="13/12/2025">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-blue-600 uppercase tracking-wider">Đến ngày</label>
                                <input type="text" id="luu_tru_den" name="luu_tru_den" class="mt-1 block w-full border border-blue-200 rounded-lg p-2" value="31/12/2025">
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button type="button" id="btnCancelEdit" onclick="cancelEdit()" class="hidden flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition font-bold">
                                Hủy
                            </button>
                            <button type="button" id="submitBtn" onclick="saveGuest()" class="flex-[2] bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition font-bold shadow-md shadow-blue-100 flex justify-center items-center">
                                <i class="fa-solid fa-user-plus mr-2"></i><span id="submitBtnText">Thêm vào danh sách</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-7">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-fit">
                    <div class="p-5 border-b bg-white flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-800">
                            Danh sách chờ gửi 
                            <span id="count" class="ml-2 px-2.5 py-0.5 bg-blue-100 text-blue-600 rounded-full text-sm font-bold">0</span>
                        </h2>
                        <button onclick="clearAll()" class="text-gray-400 hover:text-red-500 transition text-sm font-bold flex items-center">
                            <i class="fa-solid fa-trash-can mr-2"></i>Xóa sạch
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase w-10">#</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase">Khách hàng</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase">Trạng thái</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="guestTable" class="divide-y divide-gray-100 bg-white">
                                <tr id="emptyRow">
                                    <td colspan="4" class="px-6 py-12 text-center text-gray-400">
                                        <i class="fa-solid fa-inbox text-4xl mb-3 block opacity-20"></i>
                                        Chưa có dữ liệu.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let guestList = [];
        let selectedBranch = localStorage.getItem('selectedBranch') || null;

        // Kiểm tra và hiển thị modal chọn chi nhánh khi load trang
        window.addEventListener('DOMContentLoaded', function() {
            if (!selectedBranch) {
                showBranchModal();
            } else {
                // Cập nhật selector với giá trị đã lưu
                document.getElementById('branchSelect').value = selectedBranch;
            }
        });

        function showBranchModal() {
            const modal = document.getElementById('branchModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideBranchModal() {
            const modal = document.getElementById('branchModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        function selectBranch(branchValue) {
            selectedBranch = branchValue;
            localStorage.setItem('selectedBranch', branchValue);
            document.getElementById('branchSelect').value = branchValue;
            hideBranchModal();
            
            // Gửi thông tin chi nhánh đến Python để thực hiện chọn
            notifyBranchChange(branchValue);
        }

        function onBranchChange() {
            const branchSelect = document.getElementById('branchSelect');
            selectedBranch = branchSelect.value;
            localStorage.setItem('selectedBranch', selectedBranch);
            
            // Gửi thông tin chi nhánh đến Python để thực hiện chọn lại
            notifyBranchChange(selectedBranch);
        }

        async function notifyBranchChange(branchValue) {
            try {
                // Hiển thị modal đang chọn
                showBranchSelectionModal(branchValue);
                
                const response = await fetch('http://127.0.0.1:8000/set-branch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ branch: branchValue })
                });
                
                if (response.ok) {
                    console.log(`Đã chọn chi nhánh ${branchValue}`);
                } else {
                    console.error('Lỗi khi gửi thông tin chi nhánh');
                }
            } catch (error) {
                console.error('Lỗi kết nối:', error);
                alert('LỖI: Không thể kết nối với server Python!');
                hideBranchSelectionModal();
            }
        }

        function showBranchSelectionModal(branchValue) {
            const modal = document.getElementById('branchSelectionModal');
            const stepsContainer = document.getElementById('selectionSteps');
            
            // Định nghĩa các bước dựa trên chi nhánh
            const branchName = branchValue === '1' ? 'Hộ Kinh Doanh Nhà Trọ Tâm An 1' : 'NHÀ TRỌ TÂM AN 2';
            const steps = [
                { icon: 'fa-map-marker-alt', text: 'Thành phố Cần Thơ', color: 'blue' },
                { icon: 'fa-location-dot', text: 'Phường Long Tuyền', color: 'green' },
                { icon: 'fa-building', text: 'Nhà ngăn phòng cho thuê', color: 'purple' },
                { icon: 'fa-hotel', text: branchName, color: 'orange' }
            ];
            
            // Xóa nội dung cũ
            stepsContainer.innerHTML = '';
            
            // Hiển thị modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Thêm từng bước với animation
            steps.forEach((step, index) => {
                setTimeout(() => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'flex items-center p-3 bg-gray-50 rounded-lg border border-gray-200 animate-fadeIn';
                    stepDiv.innerHTML = `
                        <div class="flex-shrink-0 w-8 h-8 bg-${step.color}-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fa-solid ${step.icon} text-${step.color}-600 text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-700">${step.text}</div>
                        </div>
                        <i class="fa-solid fa-check text-green-500"></i>
                    `;
                    stepsContainer.appendChild(stepDiv);
                }, index * 500);
            });
            
            // KHÔNG tự động đóng - chờ WebSocket xác nhận từ Python
        }

        function hideBranchSelectionModal() {
            const modal = document.getElementById('branchSelectionModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        function saveGuest() {
            const form = document.getElementById('guestForm');
            const formData = new FormData(form);
            const editIndex = parseInt(document.getElementById('editIndex').value);
            
            if(!formData.get('ho_ten') || !formData.get('cccd')) return;

            const guest = {
                ho_ten: formData.get('ho_ten').toUpperCase().trim(),
                cccd: formData.get('cccd').trim(),
                ngay_birth: formData.get('ngay_birth').trim(),
                gioi_tinh: formData.get('gioi_tinh'),
                quoc_gia: "Cộng hòa xã hội chủ nghĩa Việt Nam",
                quoc_tich: formData.get('quoc_tich'),
                dan_toc: formData.get('dan_toc'),
                noi_lam_viec: formData.get('noi_lam_viec'),
                nghe_nghiep: formData.get('nghe_nghiep'),
                so_phong: formData.get('so_phong').trim(),
                tinh: formData.get('tinh').trim(),
                xa: formData.get('xa').trim(),
                ly_do: formData.get('ly_do'),
                dia_chi_chi_tiet: formData.get('dia_chi_chi_tiet').trim(),
                thoi_gian_luu_tru: formData.get('thoi_gian_luu_tru'),
                luu_tru_den: formData.get('luu_tru_den'),
                status: 'PENDING' // Trạng thái mặc định
            };

            if (editIndex > -1) {
                guestList[editIndex] = guest;
                cancelEdit();
            } else {
                guestList.push(guest);
                resetFormFields();
            }
            renderTable();
        }

        function editGuest(index) {
            const guest = guestList[index];
            document.getElementById('editIndex').value = index;
            
            // Fill form inputs (giữ nguyên logic cũ)
            document.getElementById('ho_ten').value = guest.ho_ten;
            document.getElementById('cccd').value = guest.cccd;
            document.getElementById('ngay_birth').value = guest.ngay_birth;
            document.getElementById('gioi_tinh').value = guest.gioi_tinh;
            document.getElementById('so_phong').value = guest.so_phong;
            document.getElementById('dan_toc').value = guest.dan_toc;
            document.getElementById('quoc_tich').value = guest.quoc_tich;
            document.getElementById('nghe_nghiep').value = guest.nghe_nghiep;
            document.getElementById('noi_lam_viec').value = guest.noi_lam_viec;
            document.getElementById('tinh').value = guest.tinh;
            document.getElementById('xa').value = guest.xa;
            document.getElementById('dia_chi_chi_tiet').value = guest.dia_chi_chi_tiet;
            document.getElementById('ly_do').value = guest.ly_do;
            document.getElementById('thoi_gian_luu_tru').value = guest.thoi_gian_luu_tru;
            document.getElementById('luu_tru_den').value = guest.luu_tru_den;

            document.getElementById('formTitle').innerHTML = `<i class="fa-solid fa-pen-to-square mr-2 text-amber-500"></i>Chỉnh sửa thông tin`;
            document.getElementById('submitBtnText').innerText = "Cập nhật thay đổi";
            document.getElementById('submitBtn').classList.replace('bg-blue-600', 'bg-amber-600');
            document.getElementById('submitBtn').classList.replace('hover:bg-blue-700', 'hover:bg-amber-700');
            document.getElementById('btnCancelEdit').classList.remove('hidden');
        }

        function cancelEdit() {
            document.getElementById('editIndex').value = "-1";
            resetFormFields();
            document.getElementById('formTitle').innerHTML = `<i class="fa-solid fa-user-plus mr-2 text-blue-600"></i>Thông tin chi tiết khách`;
            document.getElementById('submitBtnText').innerText = "Thêm vào danh sách";
            document.getElementById('submitBtn').classList.replace('bg-amber-600', 'bg-blue-600');
            document.getElementById('submitBtn').classList.replace('hover:bg-amber-700', 'hover:bg-blue-700');
            document.getElementById('btnCancelEdit').classList.add('hidden');
        }

        function resetFormFields() {
            document.getElementById('ho_ten').value = '';
            document.getElementById('cccd').value = '';
            document.getElementById('ngay_birth').value = '';
            document.getElementById('ho_ten').focus();
        }

        function renderTable() {
            const tableBody = document.getElementById('guestTable');
            const countEl = document.getElementById('count');
            
            if (guestList.length === 0) {
                tableBody.innerHTML = `<tr id="emptyRow"><td colspan="4" class="px-6 py-12 text-center text-gray-400 italic">Trống.</td></tr>`;
            } else {
                tableBody.innerHTML = '';
                guestList.forEach((g, index) => {
                    let statusHtml = `<span class="text-gray-400 text-xs font-medium"><i class="fa-regular fa-clock mr-1"></i>Chờ gửi</span>`;
                    let rowClass = `hover:bg-blue-50 transition border-l-4 border-transparent`; // Class mặc định

                    // Giữ lại trạng thái nếu render lại (ví dụ khi sửa user khác)
                    if (g.status === 'PROCESSING') {
                        statusHtml = `<span class="text-yellow-600 text-xs font-bold animate-pulse"><i class="fa-solid fa-spinner fa-spin mr-1"></i>Đang chạy...</span>`;
                        rowClass = `bg-yellow-50 border-l-4 border-yellow-500`;
                    } else if (g.status === 'COMPLETED') {
                        statusHtml = `<span class="text-green-600 text-xs font-bold"><i class="fa-solid fa-check-circle mr-1"></i>Thành công</span>`;
                        rowClass = `bg-green-50 border-l-4 border-green-500`;
                    } else if (g.status === 'ERROR') {
                        statusHtml = `<span class="text-red-500 text-xs font-bold"><i class="fa-solid fa-triangle-exclamation mr-1"></i>Lỗi (Đã bỏ qua)</span>`;
                        rowClass = `bg-red-50 border-l-4 border-red-500`;
                    }

                    tableBody.innerHTML += `
                        <tr id="row-${index}" class="${rowClass}">
                            <td class="px-4 py-3 text-gray-400 font-mono text-xs">${index + 1}</td>
                            <td class="px-4 py-3">
                                <div class="font-bold text-gray-900">${g.ho_ten}</div>
                                <div class="text-xs text-gray-400 font-mono font-medium">${g.cccd} | ${g.ngay_birth}</div>
                            </td>
                            <td class="px-4 py-3 text-center" id="status-cell-${index}">
                                ${statusHtml}
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center gap-3">
                                    <button onclick="editGuest(${index})" class="text-amber-500 hover:text-amber-700 p-2" title="Chỉnh sửa">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <button onclick="removeGuest(${index})" class="text-red-400 hover:text-red-600 p-2" title="Xóa">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                });
            }
            countEl.innerText = guestList.length;
        }

        function removeGuest(index) {
            if(confirm("Xóa khách này khỏi danh sách?")) {
                guestList.splice(index, 1);
                renderTable();
            }
        }

        function clearAll() {
            if(confirm("Bạn có chắc chắn muốn xóa toàn bộ danh sách?")) {
                guestList = [];
                renderTable();
            }
        }

        function exportJSON() {
            if(guestList.length === 0) return alert("Không có dữ liệu!");
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({items: guestList}, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `data_${new Date().getTime()}.json`);
            dlAnchor.click();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.items) {
                        guestList = [...guestList, ...data.items];
                        renderTable();
                    }
                } catch (err) { alert("Lỗi tệp JSON không hợp lệ!"); }
            };
            reader.readAsText(file);
        }

        async function sendToPython() {
            if (guestList.length === 0) return alert("Danh sách trống!");
            if (!selectedBranch) {
                showBranchModal();
                return alert("Vui lòng chọn chi nhánh trước!");
            }
            
            const btn = event.currentTarget;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> ĐANG GỬI...`;
            btn.disabled = true;

            // Reset status visual
            guestList.forEach(g => g.status = 'PENDING');
            renderTable();

            try {
                const response = await fetch('http://127.0.0.1:8000/send-to-web', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        items: guestList,
                        branch: selectedBranch 
                    })
                });
                const result = await response.json();
                // Không alert nữa để không chặn luồng
                console.log("Server response:", result.message);
            } catch (error) {
                alert("LỖI: Không thể kết nối với server Python (browser.py)!");
            } finally {
                btn.innerHTML = `<i class="fa-solid fa-paper-plane mr-2"></i>GỬI ĐẾN TRÌNH DUYỆT`;
                btn.disabled = false;
            }
        }

        // --- XỬ LÝ WEBSOCKET HIỂN THỊ TRẠNG THÁI ---
        const ws = new WebSocket("ws://127.0.0.1:8000/ws");
        ws.onopen = () => console.log("WebSocket: Connected");
        
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                // Xử lý xác nhận hoàn thành chọn chi nhánh
                if (data.type === 'BRANCH_SELECTED') {
                    console.log('[BRANCH] Đã nhận xác nhận từ Python:', data.message);
                    // Đóng modal sau khi nhận xác nhận
                    setTimeout(() => {
                        hideBranchSelectionModal();
                    }, 500);
                    return;
                }
                
                // Xử lý lỗi khi chọn chi nhánh
                if (data.type === 'BRANCH_ERROR') {
                    console.error('[BRANCH ERROR]', data.message);
                    alert('Lỗi khi chọn chi nhánh: ' + data.message);
                    hideBranchSelectionModal();
                    return;
                }
                
                const index = data.index;
                const row = document.getElementById(`row-${index}`);
                const statusCell = document.getElementById(`status-cell-${index}`);
                
                // Cập nhật dữ liệu gốc để không bị mất khi render lại
                if (guestList[index]) {
                    guestList[index].status = data.type;
                }

                if (!row) return;

                // 1. Reset class cũ (QUAN TRỌNG: Xóa border-transparent)
                row.className = ""; 
                
                // 2. Thêm class mới dựa trên trạng thái
                if (data.type === 'PROCESSING') {
                    row.className = "bg-yellow-50 border-l-4 border-yellow-500 transition";
                    if(statusCell) statusCell.innerHTML =   `<span class="text-yellow-600 text-xs font-bold animate-pulse"><i class="fa-solid fa-spinner fa-spin mr-1"></i>Đang chạy...</span>`;
                } else if (data.type === 'COMPLETED') {
                    row.className = "bg-green-50 border-l-4 border-green-500 transition";
                    if(statusCell) statusCell.innerHTML = `<span class="text-green-600 text-xs font-bold"><i class="fa-solid fa-check-circle mr-1"></i>Thành công</span>`;
                } else if (data.type === 'ERROR') {
                    row.className = "bg-red-50 border-l-4 border-red-500 transition";
                    if(statusCell) statusCell.innerHTML = `<span class="text-red-500 text-xs font-bold"><i class="fa-solid fa-triangle-exclamation mr-1"></i>Lỗi (Đã bỏ qua)</span>`;
                }
            } catch (e) { console.error("WS Error:", e); }
        };
    </script>
</body>
</html>